# This file is used to configure the automation rules.
# Each automation rule must have
# - a name (mandatory)
# - a topic (mandatory) - Exemples are avaibled below
# - an event (optional. Some topics don't have event type) - Exemples are avaibled below
# - an dict of filters (optional)
# - an array of actions (mandatory)
#
# FILTERS:
# Each filter is composed with a "field" and a "value". When the script is looking for an automation rule, if 
# filters are defined, the script is validating the field is present in the webhook event, and its value is 
# matching the filter value.
# The event must match all the filters to process the automation rule.
# E.g.:
# filters:
#   mac: 001122334455
#
# ACTIONS
# All the actions configured in the rule are processed by the script for each matching rule. For more information 
# about the rules configuration, please check the README file.
# The action may contain variables. The variable values must be present in the received webhook event.

- name: switch_mgmt_vlan  
  topic: "device-events"
  event: "SW_ASSIGNED"
  filters:
    org_id: xxxxxx-xxxx-xxxx-xxxx-xxxxxxxx
  actions: 
    - type: "http_request"
      method: "PUT"
      url: "https://api.mist.com/api/v1/sites/{site_id}/devices/00000000-0000-0000-1000-{mac}"
      headers: 
        Authorization: "Token xxxxxxxxxxxxxxxxMIST_APITOKENxxxxxxxxxxxxxxxx"
        Content-Type: Application/JSON
      body: 
        name: "{mac}"
        ip_config: 
          network: "infra"
    - type: "slack"        
      incoming_webhook_url: "https://hooks.slack.com/services/xxxxxxxxxxxxxxxx/xxxxxxxxxxxxxxxx/xxxxxxxxxxxxxxxx"
      title: "{site_id}: SW_ASSIGNED"
      body: "{event}"
    - type: "teams"        
      incoming_webhook_url: "https://junipernetworks.webhook.office.com/webhookb2/xxxxxx-xxxx-xxxx-xxxx-xxxxxxxx@xxxxxx-xxxx-xxxx-xxxx-xxxxxxxx/IncomingWebhook/xxxxxxxxxxxxxxxxxxxxxxxx/xxxxxx-xxxx-xxxx-xxxx-xxxxxxxx"
      title: "{site_id}: SW_ASSIGNED"
      body: "{event}"
      color: "#2196f3"

- name: audit logs
  topic: "audits"
  filters:
    admin_name: mwta
  actions: 
    - type: "slack"        
      incoming_webhook_url: "https://hooks.slack.com/services/xxxxxxxxxxxxxxxx/xxxxxxxxxxxxxxxx/xxxxxxxxxxxxxxxx"
      body: "{event}"
    - type: "teams"        
      incoming_webhook_url: "https://junipernetworks.webhook.office.com/webhookb2/xxxxxx-xxxx-xxxx-xxxx-xxxxxxxx@xxxxxx-xxxx-xxxx-xxxx-xxxxxxxx/IncomingWebhook/xxxxxxxxxxxxxxxxxxxxxxxx/xxxxxx-xxxx-xxxx-xxxx-xxxxxxxx"
      body: "{event}"
      color: "#2196f3"

# Exemple of topics / events (this list is not listing all the possibilities. Please refer to the Mist API documentation to have a more complete list)
# topic: event_channels
# event:
#   - "AP_CLAIMED"
#   - "AP_UNCLAIMED"
#   - "AP_ASSIGNED"
#   - "AP_UNASSIGNED"
#   - "AP_CONFIG_CHANGED_BY_RRM"
#   - "AP_CONFIG_CHANGED_BY_USER"
#   - "AP_CONFIG_FAILED"
#   - "AP_CONFIGURED"
#   - "AP_RECONFIGURED"
#   - "1026"
#   - "AP_RRM_ACTION"
#   - "AP_BEACON_STUCK"
#   - "AP_RESTART_BY_USER"
#   - "AP_RESTARTED"
#   - "AP_CONNECTED"
#   - "AP_DISCONNECTED"
#   - "AP_DISCONNECTED_LONG"
#   - "AP_UPGRADED"
#   - "AP_UPGRADE_BY_SCHEDULE"
#   - "AP_UPGRADE_BY_USER"
#   - "AP_UPGRADE_FAILED"
#   - "AP_RADAR_DETECTED"
#   - "AP_CERT_REGENERATED"
#   - "AP_GET_SUPPORT_FILES"
#   - "AP_RADIUS_ACCOUNTING_SERVER_CHANGE"
#   - "AP_RADIUS_AUTHENTICATION_SERVER_CHANGE"
#   - "AP_RADSEC_FAILURE"
#   - "AP_RADSEC_SERVER_CHANGE"
#   - "AP_RADSEC_RECOVERY"

#   - "GW_CLAIMED"
#   - "GW_UNCLAIMED"
#   - "GW_ASSIGNED"
#   - "GW_UNASSIGNED"
#   - "GW_ZTP_FINISHED"
#   - "GW_CONFIG_CHANGED_BY_USER"
#   - "GW_CONFIG_GENERATED"
#   - "GW_RECONFIGURED"
#   - "GW_CONFIGURED"
#   - "GW_CONFIG_LOCK_FAILED"
#   - "GW_CONFIG_FAILED"
#   - "GW_PORT_UP"
#   - "GW_PORT_DOWN"
#   - "GW_CONNECTED"
#   - "GW_DISCONNECTED"
#   - "GW_DISCONNECTED_LONG"
#   - "GW_RESTARTED"
#   - "GW_RESTARTED_BY_USER"
#   - "GW_OSPF_NEIGHBOR_UP"
#   - "GW_OSPF_NEIGHBOR_DOWN"
#   - "GW_BGP_NEIGHBOR_STATE_CHANGED"
#   - "GW_VPN_PATH_DOWN"
#   - "GW_VPN_PATH_UP"
#   - "GW_VPN_PEER_UP"
#   - "GW_VPN_PEER_DOWN"
#   - "GW_CERT_REGENERATED"
#   - "GW_ALARM"
#   - "GW_UPGRADE_BY_USER"
#   - "GW_UPGRADED"
#   - "GW_UPGRADE_PENDING"
#   - "GW_UPGRADE_FAILED"
#   - "GW_CONDUCTOR_CONNECTED"
#   - "GW_ARP_RESOLVED"
#   - "GW_ARP_UNRESOLVED"
#   - "GW_DHCP_RESOLVED"
#   - "GW_DHCP_UNRESOLVED"
#   - "GW_HA_CONTROL_LINK_UP"
#   - "GW_HA_CONTROL_LINK_DOWN"
#   - "GW_HA_HEALTH_WEIGHT_LOW"
#   - "GW_HA_HEALTH_WEIGHT_RECOVERY"
#   - "GW_CONDUCTOR_DISCONNECTED"
#   - "GW_SYSTEM_SERVICE_RESTART"
#   - "GW_REJECTED"
#   - "GW_RG_STATE_CHANGED"
#   - "GW_PORT_RG_STATE_CHANGED"
#   - "GW_PORT_RG_ST_CHANGED"
#   - "GW_RESTART_BY_USER"
#   - "GW_ALARM_POE_CONTROLLER_UPGRADE_AVAILABLE"
#   - "GW_UPGRADE_BY_MIST"

#   - "SW_CLAIMED"
#   - "SW_UNCLAIMED"
#   - "SW_ASSIGNED"
#   - "SW_UNASSIGNED"
#   - "SW_ZTP_FINISHED"
#   - "SW_CONFIG_CHANGED_BY_USER"
#   - "SW_RECONFIGURED"
#   - "SW_CONFIG_GENERATED"
#   - "SW_CONFIGURED"
#   - "SW_CONFIG_LOCK_FAILED"
#   - "SW_CONFIG_FAILED"
#   - "SW_PORT_UP"
#   - "SW_PORT_DOWN"
#   - "SW_CONNECTED"
#   - "SW_DISCONNECTED"
#   - "SW_RESTARTED"
#   - "SW_RESTART_BY_USER"
#   - "SW_OSPF_NEIGHBOR_UP"
#   - "SW_OSPF_NEIGHBOR_DOWN"
#   - "SW_BGP_NEIGHBOR_STATE_CHANGED"
#   - "SW_ALARM"
#   - "SW_ALARM_CHASSIS_PARTITION"
#   - "SW_ALARM_CHASSIS_POE"
#   - "SW_ALARM_CHASSIS_PSU"
#   - "SW_UPGRADE_BY_USER"
#   - "SW_UPGRADED"
#   - "SW_UPGRADE_PENDING"
#   - "SW_UPGRADE_FAILED"
#   - "SW_SYSTEM_SERVICE_RESTART"
#   - "SW_REJECTED"
#   - "SW_DYNAMIC_PORT_ASSIGNED"
#   - "SW_PORT_BPDU_BLOCKED"
#   - "SW_PORT_STORM_CONTROL"
#   - "SW_HANDSHAKE_ERROR"
#   - "SW_STP_TOPO_CHANGED"
#   - "SW_VC_BACKUP_ELECTED"
#   - "SW_VC_MASTER_CHANGED"
#   - "SW_VC_MEMBER_ADDED"
#   - "SW_VC_MEMBER_DELETED"
#   - "SW_MASTER_ON_RECOVERY"
#   - "SW_MEMBER_ON_RECOVERY"
#   - "SW_RECOVERY_SNAPSHOT_REQUESTED"
#   - "SW_RECOVERY_SNAPSHOT_SUCCEEDED"
#   - "SW_RECOVERY_SNAPSHOT_FAILED"
#   - "SW_RECOVERY_SNAPSHOT_NOTNEEDED"
#   - "SW_RECOVERY_SNAPSHOT_UNSUPPORTED"
#   - "SW_DOT1XD_USER_AUTHENTICATED"
#   - "SW_RADIUS_SERVER_UNREACHABLE"
#   - "SW_ALARM_POE_CONTROLLER_UPGRADE_AVAILABLE"

#   - "ME_CLAIMED"
#   - "ME_UNCLAIMED"
#   - "ME_ASSIGNED"
#   - "ME_UNASSIGNED"


# topic: updown_channels
# event:
#   - "AP_CONNECTED"
#   - "AP_DISCONNECTED"
#   - "AP_RESTARTED"
#   - "GW_CONNECTED"
#   - "GW_DISCONNECTED"
#   - "GW_RESTARTED"
#   - "SW_CONNECTED"
#   - "SW_DISCONNECTED"
#   - "SW_RESTARTED"

# topic: alarm_channels
# event:
#     # infrastructure
#   - "device_down"
#   - "device_restarted"
#   - "switch_down"
#   - "switch_restarted"
#   - "gateway_down"
#   - "device_reconnected"
#   - "switch_reconnected"
#   - "gateway_reconnected"
#   - "vpn_peer_down"
#   - "vc_master_changed"
#   - "vc_backup_failed"
#   - "vc_member_added"
#   - "vc_member_deleted"
#   - "sw_alarm_chassis_poe"
#   - "sw_alarm_chassis_pem"
#   - "sw_alarm_chassis_psu"
#   - "sw_alarm_chassis_partition"
#   - "sw_dhcp_pool_exhausted"
#   - "gw_dhcp_pool_exhausted"
#   - "sw_bgp_neighbor_state_changed"
#   - "sw_bad_optics"
#   - "sw_bpdu_error"
#   - "loop_detected_by_ap"
#   - "infra_dhcp_failure"
#   - "infra_dhcp_success"
#   - "infra_dns_failure"
#   - "infra_dns_success"
#   - "infra_arp_failure"
#   - "infra_arp_success"

#     # security
#   - "secpolicy_violation"
#   - "bssid_spoofing"
#   - "honeypot_ssid"
#   - "adhoc_network"
#   - "rogue_ap"
#   - "rogue_client"
#   - "watched_station"
#   - "eap_handshake_flood"
#   - "air_magnet_scan"
#   - "excessive_eapol_start"
#   - "eapol_logoff_attack"
#   - "eap_dictionary_attack"
#   - "disassociation_flood"
#   - "beacon_flood"
#   - "essid_jack"
#   - "krack_attack"
#   - "vendor_ie_missing"
#   - "tkip_icv_attack"
#   - "repeated_auth_failures"
#   - "eap_failure_injection"
#   - "eap_spoofed_success"
#   - "out_of_sequence"
#   - "zero_ssid_association"
#   - "monkey_jack"
#   - "excessive_client"
#   - "ssid_injection"
#     # marvis
#   - "missing_vlan"
#   - "bad_cable"
#   - "port_flap"
#   - "gw_bad_cable"
#   - "authentication_failure"
#   - "dhcp_failure"
#   - "arp_failure"
#   - "dns_failure"
#   - "negotiation_mismatch"
#   - "gw_negotiation_mismatch"
#   - "ap_offline"
#   - "non_compliant"
#   - "ap_bad_cable"
#   - "health_check_failed"
#   - "bad_wan_uplink"
#   - "switch_stp_loop"
#   - "insufficient_coverage"
#   - "insufficient_capacity"

# topic: audit_channels

# topic : mxedge_events 
# event:
#   - "ME_CONFIG_CHANGED_BY_USER"
#   - "ME_SERVICE_STOPPED"
#   - "ME_SERVICE_STARTED"
#   - "ME_SERVICE_RESTARTED"
#   - "ME_SERVICE_FAILED"
#   - "TT_TUNNELS_LOST"
#   - "ME_RESTARTED"
#   - "ME_RESOURCE_USAGE"
#   - "ME_CONFIGURED"
#   - "ME_CONNECTED"
#   - "ME_DISCONNECTED"
#   - "ME_RESTART_BY_USER"
#   - "ME_PACKAGE_INSTALLED"
#   - "ME_PACKAGE_UNINSTALLED"
#   - "ME_PACKAGE_INSTALL_FAILED"
#   - "ME_PACKAGE_UNINSTALL_FAILED"
#   - "ME_PACKAGE_UPDATED"
#   - "ME_PACKAGE_UPDATE_BY_USER"
#   - "ME_PACKAGE_UPDATE_FAILED"
#   - "ME_SERVICE_CRASHED"
#   - "TT_PORTS_BOUNCE_BY_USER"
#   - "TT_PORTS_BOUNCED"
#   - "TT_PORTS_BOUNCE_FAILED"
#   - "TT_AP_DISCONNECT_BY_USER"
#   - "TT_AP_DISCONNECTED"
#   - "TT_AP_DISCONNECT_FAILED"
#   - "ME_FAN_PLUGGED"
#   - "ME_FAN_UNPLUGGED"
#   - "ME_PSU_PLUGGED"
#   - "ME_PSU_UNPLUGGED"
#   - "ME_POWERINPUT_CONNECTED"
#   - "ME_POWERINPUT_DISCONNECTED"
#   - "TT_PORT_BLOCKED"
#   - "TT_PORT_RECOVERY"
#   - "TT_PORT_LINK_DOWN"
#   - "TT_PORT_LINK_RECOVERY"
#   - "TT_PORT_DROPPED_FROM_LACP"
#   - "TT_PORT_JOINED_LACP"
